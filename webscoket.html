<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>websocket connect</title>
</head>
<body>
  </video>
  <div>
    <input type="text" style="width: 200px;" id="url" value="127.0.0.1:8888"/>
    <button id="capture">发起连接</button>
  </div>
  <script>
    /**
 * jack 连接服务器websocket js文件
 */

var websocket = ''; // 1
var ajaxPageNum = 1;
var last_health; // 1
var health_timeout = 10; // 1
var tDates = [], tData = [];
var rightIndex;

// 上面的代码封装
var initWs = function(url) {
    if (window.WebSocket) {
        websocket = new WebSocket(
                encodeURI('ws://' + url));
        websocket.onopen = function() {
            console.log('已连接');
            websocket.send("onlinejack");
            heartbeat_timer = setInterval(function() {
                keepalive(websocket)
            }, 60000);
        };
        websocket.onerror = function() {
            console.log('连接发生错误');
        };
        websocket.onclose = function() {
            console.log('已经断开连接');
            initWs(url);
        };
        // 消息接收
        websocket.onmessage = function(message) {
            console.log(message)
            console.log(message.data)
            // 业务代码
        };
    } else {
        alert("该浏览器不支持提醒。<br/>建议使用高版本的浏览器，<br/>如 IE10、火狐 、谷歌  、搜狗等");
    }
}

// 心跳包
function keepalive(ws) {
    var time = new Date();
    if (last_health != -1 && (time.getTime() - last_health > health_timeout)) {
        // ws.close();
    } else {
        if (ws.bufferedAmount == 0) {
            ws.send('connect again from jack...');
        }
    }
}

    document.getElementById('capture').addEventListener('click', function () {
        const urlInput = document.getElementById("url");
        initWs(urlInput.value);
    })
  </script>
</body>
</html>




